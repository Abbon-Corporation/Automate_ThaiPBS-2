name: Robot Framework Web Tests
on:
  push:
    branches:
      - main
      - develop
  pull_request: null
  workflow_dispatch: null
jobs:
  heygoody_automation_web:
    runs-on: ubuntu-latest
    env:
      email_admin: ${{ secrets.EMAIL_ADMIN }}
      password_admin: ${{ secrets.PASSWORD_ADMIN }}
      TESTRAIL_URL: ${{ secrets.TESTRAIL_URL }}
      TESTRAIL_USERNAME: ${{ secrets.TESTRAIL_USERNAME }}
      TESTRAIL_API_KEY: ${{ secrets.TESTRAIL_API_KEY }}
      TESTRAIL_RUN_ID: ${{ secrets.TESTRAIL_RUN_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: |
          python --version
          pip --version
          ls -a
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip list
      - name: Install Chrome browser
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          google-chrome --version
      - name: Show directory structure
        run: tree -L 3
      - name: Kill any leftover Chrome processes
        run: pkill -f chrome || true
      - name: Start Xvfb
        run: |
          Xvfb :99 -screen 0 1920x1080x24 &>/dev/null &
          export DISPLAY=:99
      - name: Run Robot Framework tests
        working-directory: ${{ github.workspace }}
        run: pabot --processes 5 -d result -v LANG:en -v IS_CICD:true -i status:ready .
        continue-on-error: true
      - name: Generate Summary for GitHub Actions
        run: |
          rebot --output result/output.xml --report NONE --log NONE --rpa result/output.xml
      - name: Publish test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-test-result
          path: result/**
      - name: Upload Test Results to TestRail
        run: |
          python resources/custom_library/testrail_result_upload.py

      # ------------------------------
      # Added: Notify Discord on Failure
      # ------------------------------
      - name: Notify Discord on Failure
        if: failure()
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"content": "ðŸš¨ **Tests FAILED!** ðŸš¨\n\n**Repository:** ${{ github.repository }}\n**Branch:** ${{ github.ref_name }}\n**Commit:** ${{ github.sha }}\n\n[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"}' \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"

      # ------------------------------
      # Added: Notify Discord on Success
      # ------------------------------
      - name: Notify Discord on Success
        if: success()
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"content": "âœ… **All Tests PASSED!** âœ…\n\n**Repository:** ${{ github.repository }}\n**Branch:** ${{ github.ref_name }}\n**Commit:** ${{ github.sha }}\n\n[View Results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"}' \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"